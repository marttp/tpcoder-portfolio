---
import Layout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import BlogCard from "../../components/blog/BlogCard";
import TagFilter from "../../components/blog/TagFilter";
import { SOCIAL_LIST } from "../../data/social";

const posts = (await getCollection("blog")).sort((a, b) => {
  if (a.data.pubDate && b.data.pubDate) {
    return b.data.pubDate.valueOf() - a.data.pubDate.valueOf();
  }
  return 0;
});

// Extract unique tags from all posts
const allTags = [...new Set(posts.flatMap((post) => post.data.tags))].sort();
---

<Layout
  title="Blog"
  description="List of blog posts written by me (Thanaphoom Babparn)"
>
  <!-- Tab Navigation -->
  <div class="flex justify-center mb-8">
    <div class="inline-flex rounded-lg border border-gray-300 dark:border-gray-600 p-1 bg-gray-100 dark:bg-gray-800">
      <button
        id="tab-local"
        class="tab-btn px-6 py-2 rounded-md text-sm font-medium transition-all"
        data-tab="local"
      >
        Local Blog
      </button>
      <button
        id="tab-medium"
        class="tab-btn px-6 py-2 rounded-md text-sm font-medium transition-all"
        data-tab="medium"
      >
        Medium Articles
      </button>
    </div>
  </div>

  <!-- Medium Articles Section -->
  <section id="medium-content" class="tab-content flex flex-col justify-center items-center">
    <div class="text-center max-w-2xl">
      <p class="text-sm mb-6 text-gray-600 dark:text-gray-400">
        I write articles on Medium covering software development, technology insights, and more. You can read them freely without any subscription.
      </p>
      <a
        href={SOCIAL_LIST[1].url}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-block bg-primary-light text-text py-3 px-6 rounded-full text-sm font-medium hover:bg-primary-dark hover:text-white transition-colors"
      >
        View Medium Profile
      </a>
    </div>
  </section>

  <!-- Local Blog Section -->
  <section id="local-content" class="tab-content hidden">
    <!-- Search Input -->
  <div class="w-full max-w-md mx-auto mb-6">
    <div class="relative">
      <input
        id="searchInput"
        type="text"
        placeholder="Search blog posts..."
        class="w-full py-2 px-4 pr-10 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
      />
      <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
    </div>
  </div>

  <!-- Tag Filter -->
  <TagFilter tags={allTags} client:only="solid-js" />

  <!-- Blog Posts Grid -->
  <div id="blogContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
    {
      posts.map((post) => (
        <div
          class="blog-item"
          data-blog-title={post.data.title.toLowerCase()}
          data-blog-description={post.data.description.toLowerCase()}
          data-blog-tags={post.data.tags.join(",").toLowerCase()}
        >
          <BlogCard
            post={{
              slug: post.slug,
              title: post.data.title,
              description: post.data.description,
              pubDate: post.data.pubDate,
              heroImage: post.data.heroImage,
              tags: post.data.tags,
              language: post.data.language,
            }}
            client:only="solid-js"
          />
        </div>
      ))
    }
  </div>

    <div id="noResults" class="hidden text-center py-8 text-gray-500 dark:text-gray-400">
      No blog posts found matching your search. Try different keywords or tags.
    </div>
  </section>
</Layout>

<style>
  .tab-btn {
    color: #6b7280;
  }
  .tab-btn.active {
    background-color: white;
    color: #111827;
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  }
  :global(.dark) .tab-btn {
    color: #9ca3af;
  }
  :global(.dark) .tab-btn.active {
    background-color: #374151;
    color: #f9fafb;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Tab switching logic
    const tabButtons = document.querySelectorAll(".tab-btn");
    const mediumContent = document.getElementById("medium-content");
    const localContent = document.getElementById("local-content");

    const switchTab = (tab: string) => {
      tabButtons.forEach((btn) => {
        if (btn.getAttribute("data-tab") === tab) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });

      if (tab === "medium") {
        mediumContent?.classList.remove("hidden");
        localContent?.classList.add("hidden");
      } else {
        mediumContent?.classList.add("hidden");
        localContent?.classList.remove("hidden");
      }
    };

    // Set default active tab
    switchTab("medium");

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        if (tab) switchTab(tab);
      });
    });

    // Blog search and filter logic
    const searchInput = document.getElementById("searchInput") as HTMLInputElement;
    const blogItems = document.querySelectorAll(".blog-item");
    const noResults = document.getElementById("noResults");

    let currentSearchTerm = "";
    let currentTag = "all";

    if (!searchInput || !noResults) return;

    const filterPosts = () => {
      let hasVisiblePosts = false;

      blogItems.forEach((item) => {
        const title = item.getAttribute("data-blog-title") || "";
        const description = item.getAttribute("data-blog-description") || "";
        const tags = item.getAttribute("data-blog-tags") || "";

        const matchesSearch =
          currentSearchTerm === "" ||
          title.includes(currentSearchTerm) ||
          description.includes(currentSearchTerm) ||
          tags.includes(currentSearchTerm);

        const matchesTag =
          currentTag === "all" || tags.split(",").includes(currentTag.toLowerCase());

        if (matchesSearch && matchesTag) {
          item.classList.remove("hidden");
          hasVisiblePosts = true;
        } else {
          item.classList.add("hidden");
        }
      });

      if (hasVisiblePosts) {
        noResults.classList.add("hidden");
      } else {
        noResults.classList.remove("hidden");
      }
    };

    // Search input handler
    searchInput.addEventListener("input", function (this: HTMLInputElement) {
      currentSearchTerm = this.value.toLowerCase().trim();
      filterPosts();
    });

    // Global tag filter handler
    window.handleTagFilter = (tag: string) => {
      currentTag = tag;
      filterPosts();
    };
  });
</script>
